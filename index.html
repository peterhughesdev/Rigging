<html>
	<head>
		<title>Rigging</title>
	
        <link href="https://cdn.quilljs.com/1.1.4/quill.bubble.css" rel="stylesheet">
        <style>
             #container { display : flex; }
             #container > div { flex : 1 1 auto; width : 50%; }
             #editor { background : #fafbea; }
             #view { background : #fff;  border-left : 1px solid #ccc; }
             #error { background : #ef8e8e; color : #fff; }

        </style>
	</head>
	<body>
            <button id="new-file">New</button>
            <button id="load-file">Load</button>
            <button id="save-file">Save</button>
            <button id="preview-file">Preview</button>
        <div id="container">
            <div id="editor">
                <p>Start writing...</p>
            </div>
            <div id="view">
            </div>
        </div>
        <div id="error"></div>

        <script src="https://cdn.quilljs.com/1.1.4/quill.js"></script>
        <script>
            var Electron = require('electron');
            
            var dialog = Electron.remote.dialog;

            var render = require('quill-render');
            var fs = require('fs');

            Rigging = require('./src/rigging');
        </script>
        <script>
              var currentFile = null;

              var quill = new Quill('#editor', {
                  theme: 'bubble'
              });

              var rigging = new Rigging({
                  render : function(html) {
                      document.querySelector('#view').innerHTML = html;
                  },
                  onError : function(err) {
                      console.log(err);
                  }
              });

              function parseContents() {
                  rigging.parse(render(quill.getContents().ops).replace(/&quot;/g, '"'));
              }

              quill.on('text-change', parseContents);
              parseContents();

              document.getElementById('new-file').addEventListener('click', function() {
                  currentFile = null;
                  quill.setText("");
                  parseContents();
              });

              document.getElementById('load-file').addEventListener('click', function() {
                  dialog.showOpenDialog(function(filename) {
                      fs.readFile(filename[0], 'utf-8', function(err, data) {
                          if (err) {
                              console.log(err);
                          } else {
                              currentFile = filename[0];

                              quill.setContents(JSON.parse(data));
                              
                              parseContents();
                          }
                      });
                  }); 
              });


              function save(filename) {
                  var contents = JSON.stringify(quill.getContents(), null, 2);

                  fs.writeFile(filename, contents, function(e) {
                      if (e) { console.log(e); }
                  });    
              }

              document.getElementById('save-file').addEventListener('click', function() {
                  if (currentFile) {
                     save(currentFile); 
                  } else {
                      dialog.showSaveDialog(function(filename) {
                          currentFile = filename;
                          save(filename);
                      });
                  }
              });

              
              var Nunjucks = require('nunjucks');

              function createPreview(cb) {
                  fs.readFile(`${__dirname}/preview.html`, 'utf-8', function(err, data) {
                      if (err) {
                          console.log(err);
                      } else {
                          var template = Nunjucks.compile(data);
                          var contents = template.render({
                              data : JSON.stringify(quill.getContents())
                          });

                          var filename = `${__dirname}/previews/preview-` + Date.now() + '.html';

                          fs.writeFile(filename, contents, function(err) {
                              cb(err, filename);
                          });
                      }
                  });
              }

              document.getElementById('preview-file').addEventListener('click', function() {
                  createPreview(function(err, filename) {
                      if (err) {
                          console.log(err);
                      } else {
                          window.open('file://' + filename);
                      }
                  });
              });
        </script>
    </body>
</html>
