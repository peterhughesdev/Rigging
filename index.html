<html>
	<head>
		<title>Rigging</title>
	
        <link href="https://cdn.quilljs.com/1.1.4/quill.bubble.css" rel="stylesheet">
        <style>
             #container { display : flex; }
             #container > div { flex : 1 1 auto; width : 50%; }
             #editor { background : #fafbea; }
             #view { background : #fff;  border-left : 1px solid #ccc; }
             #error { background : #ef8e8e; color : #fff; }

        </style>
	</head>
	<body>
            <button id="load-file">Load</button>
            <button id="save-file">Save</button>
        <div id="container">
            <div id="editor">
                <p>Start writing...</p>
            </div>
            <div id="view">
            </div>
        </div>
        <div id="error"></div>

        <script src="https://cdn.quilljs.com/1.1.4/quill.js"></script>
        <script>
            var fs = require('fs');
            var dialog = require('electron').remote.dialog;

            Rigging = require('./src/rigging');
        </script>
        <script>
              var currentFile = null;

              var quill = new Quill('#editor', {
                  theme: 'bubble'
              });

              var rigging = new Rigging({
                  render : function(html) {
                      document.querySelector('#view').innerHTML = html;
                  },
                  onError : function(err) {
                      console.log(err);
                  }
              });

              quill.on('text-change', function() {
                  rigging.parse(quill.getText());
              });

              document.getElementById('load-file').addEventListener('click', function() {
                  dialog.showOpenDialog(function(filename) {
                      fs.readFile(filename[0], 'utf-8', function(err, data) {
                          if (err) {
                              console.log(err);
                          } else {
                              currentFile = filename[0];

                              var contents = JSON.parse(data);
                              quill.setContents(contents);
                              rigging.parse(quill.getText());
                          }
                      });
                  }); 
              });


              function save(filename) {
                  var contents = JSON.stringify(quill.getContents(), null, 2);

                  fs.writeFile(filename, contents, function(e) {
                      if (e) { console.log(e); }
                  });    
              }

              document.getElementById('save-file').addEventListener('click', function() {
                  if (currentFile) {
                     save(currentFile); 
                  } else {
                      dialog.showSaveDialog(function(filename) {
                          currentFile = filename;
                          save(filename);
                      });
                  }
              });
        </script>
    </body>
</html>
